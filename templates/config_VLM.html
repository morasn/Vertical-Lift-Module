
<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>VLM Configuration</title>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
	<script>
	document.addEventListener('DOMContentLoaded', function () {
		const form = document.getElementById('configForm');
		const statusDiv = document.getElementById('status');

		// Helper to show values (inputs + display table)
		function showConfig(cfg) {
			if (!cfg) return;
			if (document.getElementById('show_normal_speed')) document.getElementById('show_normal_speed').textContent = cfg.Normal_Speed;
			if (document.getElementById('show_approach_speed')) document.getElementById('show_approach_speed').textContent = cfg.Approach_Speed;
			if (document.getElementById('show_stop_pulse')) document.getElementById('show_stop_pulse').textContent = cfg.Stop_Pulse;
			if (document.getElementById('show_for_pulse')) document.getElementById('show_for_pulse').textContent = (cfg.For_Pulse - 1500);
			if (document.getElementById('show_steps_per_floor')) document.getElementById('show_steps_per_floor').textContent = cfg.Steps_Per_Floor;
			if (document.getElementById('show_back_pulse')) document.getElementById('show_back_pulse').textContent = cfg.Back_Pulse;
			if (document.getElementById('show_collect_time')) document.getElementById('show_collect_time').textContent = cfg.Collect_Time;
			if (document.getElementById('show_return_time')) document.getElementById('show_return_time').textContent = cfg.Return_Time;
			if (document.getElementById('show_hall_N')) document.getElementById('show_hall_N').textContent = cfg.hall_N_thresh;
			if (document.getElementById('show_hall_S')) document.getElementById('show_hall_S').textContent = cfg.hall_S_thresh;
			if (document.getElementById('show_last_updated')) document.getElementById('show_last_updated').textContent = cfg.Last_Updated || '';

			// populate inputs
			if (document.getElementById('Normal_Speed')) document.getElementById('Normal_Speed').value = cfg.Normal_Speed;
			if (document.getElementById('Approach_Speed')) document.getElementById('Approach_Speed').value = cfg.Approach_Speed;
			if (document.getElementById('Stop_Pulse')) document.getElementById('Stop_Pulse').value = cfg.Stop_Pulse;
			if (document.getElementById('For_Pulse')) document.getElementById('For_Pulse').value = cfg.For_Pulse;
			if (document.getElementById('Back_Pulse')) document.getElementById('Back_Pulse').value = cfg.Back_Pulse;
			if (document.getElementById('Collect_Time')) document.getElementById('Collect_Time').value = cfg.Collect_Time;
			if (document.getElementById('Return_Time')) document.getElementById('Return_Time').value = cfg.Return_Time;
			if (document.getElementById('hall_N_thresh')) document.getElementById('hall_N_thresh').value = cfg.hall_N_thresh;
			if (document.getElementById('hall_S_thresh')) document.getElementById('hall_S_thresh').value = cfg.hall_S_thresh;

			if (document.getElementById('horizontal_pwm')) document.getElementById('horizontal_pwm').value = (cfg.For_Pulse - 1500) || '';
			if (document.getElementById('pwm_help')) document.getElementById('pwm_help').textContent = `Current PWM - Back: ${cfg.Back_Pulse}, Stop: ${cfg.Stop_Pulse}, Forward: ${cfg.For_Pulse} (Δ=${cfg.For_Pulse-1500}). (Note: max Back=1000, stop=1500, max Forward=2000)`;
			if (document.getElementById('vertical_info')) document.getElementById('vertical_info').textContent = `Normal Speed: ${cfg.Normal_Speed} μs, Approach Speed: ${cfg.Approach_Speed} μs`;
		}

		// initial load
		fetch('/api/vlm_config').then(r => r.json()).then(cfg => { if (!cfg.error) showConfig(cfg); }).catch(()=>{});

		form.addEventListener('submit', async function (e) {
			e.preventDefault();
			const data = {
				Normal_Speed: parseInt(document.getElementById('Normal_Speed').value, 10),
				Approach_Speed: parseInt(document.getElementById('Approach_Speed').value, 10),
				Steps_Per_Floor: parseInt(document.getElementById('Steps_Per_Floor').value, 10),
				Stop_Pulse: parseInt(document.getElementById('Stop_Pulse').value, 10),
				For_Pulse: 1500 + parseInt(document.getElementById('For_Pulse').value, 10),
				Back_Pulse: parseInt(document.getElementById('Back_Pulse').value, 10),
				Collect_Time: parseInt(document.getElementById('Collect_Time').value, 10),
				Return_Time: parseInt(document.getElementById('Return_Time').value, 10),
				hall_N_thresh: parseInt(document.getElementById('hall_N_thresh').value, 10),
				hall_S_thresh: parseInt(document.getElementById('hall_S_thresh').value, 10)
			};
			try {
				const response = await fetch('/api/vlm_config', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(data) });
				const result = await response.json();
				if (response.ok) {
					statusDiv.textContent = result.message; statusDiv.className='alert alert-success';
					fetch('/api/vlm_config').then(r=>r.json()).then(cfg=>{ if(!cfg.error) showConfig(cfg); }).catch(()=>{});
				} else {
					statusDiv.textContent = result.error || 'Error updating config.'; statusDiv.className='alert alert-danger';
				}
			} catch (err) {
				statusDiv.textContent = 'Network error.'; statusDiv.className='alert alert-danger';
			}
		});

		// Manual control functions (global)
		window.sendVertical = async function() {
			const steps = parseInt(document.getElementById('vertical_steps').value, 10);
			const dirVal = document.getElementById('vertical_direction').value;
			const payload = { steps };
			if (dirVal === '1') payload.direction = true;
			else if (dirVal === '-1') payload.direction = false;
			try {
				const res = await fetch('/api/vlm_vertical', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload)});
				const data = await res.json();
				alert(JSON.stringify(data));
			} catch (e) { alert('Network error'); }
		}

		window.sendHorizontal = async function() {
			const duration_sec = parseFloat(document.getElementById('horizontal_duration').value);
			const left_pwm = parseInt(document.getElementById('horizontal_left_pwm').value, 10);
			const right_pwm = parseInt(document.getElementById('horizontal_right_pwm').value, 10);
			const payload = { duration_sec, left_pwm, right_pwm };
			try {
				const res = await fetch('/api/vlm_horizontal', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload)});
				const data = await res.json();
				alert(JSON.stringify(data));
			} catch (e) { alert('Network error'); }
		}

		window.requestHall = async function() {
			try {
				const res = await fetch('/api/vlm_hall_immediate');
				const data = await res.json();
				document.getElementById('hall_status').textContent = data.message || JSON.stringify(data);
			} catch (e) { document.getElementById('hall_status').textContent = 'Network error'; }
		}

	});
	</script>
</head>
<body class="bg-light">
	<div class="container mt-5">
		<h2 class="mb-4">VLM Configuration Table</h2>
		<div id="stored_params" class="mb-4">
			<h4>Stored Parameters</h4>
			<table class="table table-sm">
				<tbody>
					<tr><td class="fw-semibold">Normal Speed</td><td id="show_normal_speed"></td></tr>
					<tr><td class="fw-semibold">Approach Speed</td><td id="show_approach_speed"></td></tr>
					<tr><td class="fw-semibold">Stop Pulse</td><td id="show_stop_pulse"></td></tr>
					<tr><td class="fw-semibold">Forward Pulse (Δ from 1500)</td><td id="show_for_pulse"></td></tr>
					<tr><td class="fw-semibold">Steps Per Floor</td><td id="show_steps_per_floor"></td></tr>
					<tr><td class="fw-semibold">Backward Pulse</td><td id="show_back_pulse"></td></tr>
					<tr><td class="fw-semibold">Collect Time (ms)</td><td id="show_collect_time"></td></tr>
					<tr><td class="fw-semibold">Return Time (ms)</td><td id="show_return_time"></td></tr>
					<tr><td class="fw-semibold">Hall N Threshold</td><td id="show_hall_N"></td></tr>
					<tr><td class="fw-semibold">Hall S Threshold</td><td id="show_hall_S"></td></tr>
					<tr><td class="fw-semibold">Last Updated</td><td id="show_last_updated"></td></tr>
				</tbody>
			</table>
		</div>
		<form id="configForm">
			<table class="table table-bordered table-striped">
				<thead class="table-dark">
					<tr>
						<th>Parameter</th>
						<th>Value</th>
					</tr>
				</thead>
				<tbody>
					<tr><td>Normal Speed</td><td><input type="number" id="Normal_Speed" name="Normal_Speed" class="form-control" required></td></tr>
					<tr><td>Approach Speed</td><td><input type="number" id="Approach_Speed" name="Approach_Speed" class="form-control" required></td></tr>
					<tr><td>Stop Pulse</td><td><input type="number" id="Stop_Pulse" name="Stop_Pulse" class="form-control" required></td></tr>
					<tr><td>Forward Pulse (Δ from 1500)</td><td><input type="number" id="For_Pulse" name="For_Pulse" class="form-control" required></td></tr>
					<tr><td>Steps Per Floor</td><td><input type="number" id="Steps_Per_Floor" name="Steps_Per_Floor" class="form-control" required></td></tr>
					<tr><td>Backward Pulse</td><td><input type="number" id="Back_Pulse" name="Back_Pulse" class="form-control" required></td></tr>
					<tr><td>Collect Time</td><td><input type="number" id="Collect_Time" name="Collect_Time" class="form-control" required></td></tr>
					<tr><td>Return Time</td><td><input type="number" id="Return_Time" name="Return_Time" class="form-control" required></td></tr>
					<tr><td>Hall Sensor N Threshold</td><td><input type="number" id="hall_N_thresh" name="hall_N_thresh" class="form-control" required></td></tr>
					<tr><td>Hall Sensor S Threshold</td><td><input type="number" id="hall_S_thresh" name="hall_S_thresh" class="form-control" required></td></tr>
				</tbody>
			</table>
			<button type="submit" class="btn btn-primary">Submit</button>
		</form>
		<div id="status" class="mt-3"></div>

			{% if session['Access_Level'] > 1 %}
			<!-- Manual Motion / Sensor Controls -->
			<div class="mt-4">
				<h3 class="mb-3">Manual Motion & Sensor</h3>
				<div class="row g-3">
					<div class="col-md-4">
						<h5>Vertical Motion (steps)</h5>
						<input id="vertical_steps" type="number" class="form-control mb-2" placeholder="Steps">
						<select id="vertical_direction" class="form-select mb-2">
							<option value="">(auto)</option>
							<option value="1">Up</option>
							<option value="-1">Down</option>
						</select>
						<div id="vertical_info" class="form-text text-muted">Speed: -- / --</div>
						<button class="btn btn-primary" onclick="sendVertical()">Send Vertical (600)</button>
					</div>
					<div class="col-md-4">
						<h5>Horizontal Motion</h5>
						<input id="horizontal_duration" type="number" step="0.1" class="form-control mb-2" placeholder="Duration (seconds)">
						<input id="horizontal_left_pwm" type="number" class="form-control mb-2" placeholder="Left PWM (1000-2000)">
						<input id="horizontal_right_pwm" type="number" class="form-control mb-2" placeholder="Right PWM (1000-2000)">
						<div id="pwm_help" class="form-text text-muted">PWM: max Back=1000, Stop=1500, max Forward=2000.</div>
						<button class="btn btn-primary" onclick="sendHorizontal()">Send Horizontal (601)</button>
					</div>
					<div class="col-md-4">
						<h5>Hall Sensor</h5>
						<button class="btn btn-info mb-2" onclick="requestHall()">Request Hall Read (602)</button>
						<div id="hall_status" class="mt-2 text-muted"></div>
					</div>
				</div>
			</div>
			{% endif %}
	</div>
</body>
</html>
